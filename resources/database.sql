-- 创建数据库
DROP DATABASE IF EXISTS LibraryDB;
CREATE DATABASE LibraryDB;
USE LibraryDB;

-- 创建图书信息表
CREATE TABLE bookInformation (
    bookId VARCHAR(20) PRIMARY KEY,
    isbn VARCHAR(13) NOT NULL,
    bookName VARCHAR(255) NOT NULL,
    bookAuthor VARCHAR(100) NOT NULL,
    bookPublisher VARCHAR(100),
    bookPubDate DATE,
    bookCategory VARCHAR(50),
    bookLocation VARCHAR(50) NOT NULL,
    bookTotalCopies INT,
    bookAvailableCopies INT,
    bookPrice INT NOT NULL,
    borrowCount BIGINT NOT NULL,
    CONSTRAINT chk_bookTotalCopies CHECK(bookTotalCopies >= 1),
    CONSTRAINT chk_bookAvailableCopies CHECK(bookAvailableCopies >= 0 AND bookAvailableCopies <= bookTotalCopies)
);

-- 创建读者信息表
CREATE TABLE readerInformation (
    readerId VARCHAR(20) PRIMARY KEY,
    readerName VARCHAR(50) NOT NULL,
    readerCardType VARCHAR(20) NOT NULL,
    readerCardNumber VARCHAR(30) NOT NULL UNIQUE,
    readerPhoneNumber VARCHAR(20),
    registerDate DATE NOT NULL,
    readerStatus INT,
    totalBorrowNumber INT NOT NULL,
    nowBorrowNumber INT NOT NULL
);

-- 创建借阅登记表
CREATE TABLE borrowTable (
    borrowId VARCHAR(20) PRIMARY KEY,
    bookId VARCHAR(20),
    readerId VARCHAR(20),
    borrowDate DATE NOT NULL,
    dueDate DATE NOT NULL,
    borrowStates INT NOT NULL,
    FOREIGN KEY (bookId) REFERENCES bookInformation(bookId),
    FOREIGN KEY (readerId) REFERENCES readerInformation(readerId)
);

-- 创建归还登记表
CREATE TABLE returnTable (
    returnId VARCHAR(20) PRIMARY KEY,
    borrowId VARCHAR(20) NOT NULL,
    returnDate DATE NOT NULL,
    overDays INT NOT NULL,
    fine DOUBLE NOT NULL,
    FOREIGN KEY (borrowId) REFERENCES borrowTable(borrowId)
);



CREATE UNIQUE INDEX uk_isbn ON bookInformation (isbn);
CREATE INDEX idx_bookName ON bookInformation (bookName);
CREATE INDEX idx_bookAuthor ON bookInformation (bookAuthor);
CREATE INDEX idx_bookCategory ON bookInformation (bookCategory);
CREATE INDEX idx_availableCopies ON bookInformation (bookAvailableCopies);

-- 读者信息表索引
CREATE UNIQUE INDEX uk_cardNumber ON readerInformation (readerCardNumber);
CREATE INDEX idx_readerName ON readerInformation (readerName);
CREATE INDEX idx_readerStatus ON readerInformation (readerStatus);

-- 借阅登记表索引
CREATE INDEX fk_bookId ON borrowTable (bookId);
CREATE INDEX fk_readerId ON borrowTable (readerId);
CREATE INDEX idx_borrowStates ON borrowTable (borrowStates);
CREATE INDEX idx_dueDate ON borrowTable (dueDate);
CREATE INDEX idx_reader_borrow ON borrowTable (readerId, borrowDate);
CREATE INDEX idx_book_stats ON borrowTable (bookId, borrowDate);

-- 归还登记表索引
CREATE INDEX fk_borrowId ON returnTable (borrowId);
CREATE INDEX idx_returnDate ON returnTable (returnDate);


-- 插入测试数据
-- 插入图书数据 (40条)
INSERT INTO bookInformation (bookId, bookName, bookAuthor, bookPublisher, bookPubDate, bookCategory, bookLocation, bookTotalCopies, bookAvailableCopies, isbn, bookPrice, borrowCount) VALUES
('1', 'Java核心技术', 'Cay S. Horstmann', '机械工业出版社', '2022-01-01', '计算机', 'A区001架01层', 10, 5, '9787111601157', 128, 15),
('2', 'JavaScript高级程序设计', 'Matt Frisbie', '人民邮电出版社', '2020-05-15', '计算机', 'A区002架03层', 8, 2, '9787115547345', 139, 8),
('3', '红楼梦', '曹雪芹', '人民文学出版社', '2019-08-20', '文学', 'B区005架02层', 15, 10, '9787020002207', 45, 5),
('4', '西游记', '吴承恩', '人民文学出版社', '2018-12-10', '文学', 'B区006架01层', 12, 7, '9787020002221', 40, 14),
('5', '数据结构与算法分析', 'Mark Allen Weiss', '机械工业出版社', '2021-03-18', '计算机', 'A区003架04层', 6, 1, '9787111488877', 89, 10),
('6', 'Python编程：从入门到实践', 'Eric Matthes', '人民邮电出版社', '2021-01-01', '计算机', 'A区004架02层', 12, 8, '9787115428028', 79, 9),
('7', '三国演义', '罗贯中', '人民文学出版社', '2020-05-01', '文学', 'B区007架03层', 10, 3, '9787020002238', 42, 14),
('8', '活着', '余华', '作家出版社', '2019-10-01', '文学', 'B区008架01层', 15, 0, '9787506365437', 20, 6),
('9', '深入理解计算机系统', 'Randal E. Bryant', '机械工业出版社', '2022-03-15', '计算机', 'A区005架05层', 7, 2, '9787111544937', 169, 11),
('10', '百年孤独', '加西亚·马尔克斯', '南海出版公司', '2021-07-01', '文学', 'B区009架02层', 9, 4, '9787544256497', 59, 4),
('11', '设计模式', 'GoF', '机械工业出版社', '2020-02-01', '计算机', 'A区006架04层', 5, 1, '9787111601164', 69, 15),
('12', '算法导论', 'Thomas H. Cormen', '机械工业出版社', '2019-05-01', '计算机', 'A区007架02层', 6, 0, '9787111601171', 129, 9),
('13', '数学之美', '吴军', '人民邮电出版社', '2021-03-01', '科学', 'C区001架03层', 8, 3, '9787115601188', 79, 7),
('14', '经济学原理', 'N. Gregory Mankiw', '北京大学出版社', '2020-08-01', '经济', 'D区002架01层', 7, 2, '9787115601195', 99, 6),
('15', '人类简史', '尤瓦尔·赫拉利', '中信出版社', '2019-01-01', '历史', 'E区003架05层', 10, 6, '9787115601201', 69, 7),
('16', '明朝那些事儿', '当年明月', '中国海关出版社', '2021-06-01', '历史', 'E区004架02层', 12, 7, '9787115601218', 28, 15),
('17', '时间简史', '史蒂芬·霍金', '湖南科学技术出版社', '2020-04-01', '科学', 'C区005架01层', 9, 4, '9787115601225', 49, 11),
('18', '围城', '钱钟书', '人民文学出版社', '2018-09-01', '文学', 'B区010架03层', 11, 5, '9787115601232', 39, 8),
('19', '机器学习', '周志华', '清华大学出版社', '2021-01-01', '计算机', 'A区008架04层', 6, 1, '9787115601249', 99, 11),
('20', '艺术的故事', 'E.H.贡布里希', '广西美术出版社', '2019-12-01', '艺术', 'F区001架02层', 5, 2, '9787115601256', 299, 6),
('21', '三体', '刘慈欣', '重庆出版社', '2006-05-01', '科幻小说', 'A区001架', 5, 3, '9787536692930', 23, 15),
('22', '三体Ⅱ·黑暗森林', '刘慈欣', '重庆出版社', '2008-01-01', '科幻小说', 'A区002架', 5, 4, '9787536693975', 30, 8),
('23', '三体Ⅲ·死神永生', '刘慈欣', '重庆出版社', '2010-11-01', '科幻小说', 'A区003架', 5, 5, '9787229039017', 32, 5),
('24', '围城', '钱钟书', '人民文学出版社', '2009-07-01', '现代文学', 'B区002架', 6, 4, '9787020024878', 25, 10),
('25', '百年孤独', '加西亚·马尔克斯', '南海出版公司', '2011-06-01', '外国文学', 'C区001架', 7, 5, '9787544253994', 35, 9),
('26', '1984', '乔治·奥威尔', '译林出版社', '2010-01-01', '外国文学', 'C区002架', 6, 3, '9787544253949', 22, 14),
('27', '动物农场', '乔治·奥威尔', '译林出版社', '2012-03-01', '外国文学', 'C区003架', 5, 4, '9787544253963', 18, 6),
('28', '红楼梦', '曹雪芹', '人民文学出版社', '2008-08-01', '古典文学', 'D区001架', 10, 7, '9787020002203', 45, 18),
('29', '西游记', '吴承恩', '人民文学出版社', '2007-09-01', '古典文学', 'D区002架', 8, 6, '9787020008731', 40, 11),
('30', '三国演义', '罗贯中', '人民文学出版社', '2009-06-01', '古典文学', 'D区003架', 8, 7, '9787020008748', 42, 7),
('31', '水浒传', '施耐庵', '人民文学出版社', '2008-05-01', '古典文学', 'D区004架', 7, 5, '9787020008755', 38, 9),
('32', '哈利·波特与魔法石', 'J.K.罗琳', '人民文学出版社', '2011-08-01', '奇幻小说', 'E区001架', 6, 4, '9787020033023', 36, 13),
('33', '哈利·波特与密室', 'J.K.罗琳', '人民文学出版社', '2010-09-01', '奇幻小说', 'E区002架', 6, 5, '9787020033030', 34, 8),
('34', '哈利·波特与阿兹卡班囚徒', 'J.K.罗琳', '人民文学出版社', '2012-07-01', '奇幻小说', 'E区003架', 5, 3, '9787020033047', 37, 11),
('35', '哈利·波特与火焰杯', 'J.K.罗琳', '人民文学出版社', '2011-06-01', '奇幻小说', 'E区004架', 5, 4, '9787020033054', 39, 6),
('36', '哈利·波特与凤凰社', 'J.K.罗琳', '人民文学出版社', '2010-05-01', '奇幻小说', 'E区005架', 5, 5, '9787020033061', 41, 4),
('37', '哈利·波特与混血王子', 'J.K.罗琳', '人民文学出版社', '2009-04-01', '奇幻小说', 'E区006架', 6, 4, '9787020033078', 38, 7),
('38', '哈利·波特与死亡圣器', 'J.K.罗琳', '人民文学出版社', '2008-03-01', '奇幻小说', 'E区007架', 6, 6, '9787020033085', 42, 5),
('39', '福尔摩斯探案全集', '阿瑟·柯南·道尔', '中华书局', '2013-01-01', '推理小说', 'F区001架', 4, 2, '9787101085486', 55, 12),
('40', '达芬奇密码', '丹·布朗', '人民文学出版社', '2012-02-01', '推理小说', 'F区002架', 5, 3, '9787020056886', 29, 9);

-- 插入读者数据 (15条)
INSERT INTO readerInformation (readerId, readerName, readerCardType, readerCardNumber, readerPhoneNumber, registerDate, readerStatus, totalBorrowNumber, nowBorrowNumber, borrowLimit) VALUES
('1001', '张三', '身份证', '110101199003077856', '13800138000', '2023-01-15', 0, 5, 3, 5),
('1002', '李四', '身份证', '110101198512038914', '13900139000', '2023-02-20', 0, 5, 1, 5),
('1003', '王五', '身份证', '110101199208156732', '13700137000', '2023-03-10', 0, 5, 0, 5),
('1004', '赵六', '学生证', '2023001234', '13600136000', '2023-04-05', 0, 3, 2, 3),
('1005', '钱七', '身份证', '110101199106125432', '13500135000', '2023-05-12', 0, 5, 0, 5),
('1006', '孙八', '学生证', '2023005678', '13400134000', '2023-06-18', 0, 3, 1, 3),
('1007', '周九', '身份证', '110101198811223344', '13300133000', '2023-07-22', 1, 5, 2, 5),
('1008', '吴十', '学生证', '2023009999', '13200132000', '2023-08-15', 0, 3, 0, 3),
('1009', '郑十一', '身份证', '110101199310102233', '13100131000', '2023-09-01', 0, 5, 4, 5),
('1010', '王十二', '教师证', 'T2023000001', '13000130000', '2023-09-20', 0, 10, 2, 10),
('1011', '李十三', '身份证', '110101198005051122', '15900159000', '2023-10-05', 0, 5, 1, 5),
('1012', '陈十四', '学生证', '2023008888', '15800158000', '2023-10-18', 0, 3, 0, 3),
('1013', '黄十五', '身份证', '110101199508083344', '15700157000', '2023-11-01', 0, 5, 1, 5),
('1014', '徐十六', '学生证', '2023007777', '15600156000', '2023-11-05', 0, 3, 2, 3),
('1015', '何十七', '教师证', 'T2023000002', '15500155000', '2023-11-10', 0, 10, 3, 10);

-- 插入借阅记录数据 (20条)
INSERT INTO borrowTable (borrowId, bookId, readerId, borrowDate, dueDate, borrowStates) VALUES
('20230001', '1', '1001', '2025-11-01', '2025-12-01', 0),
('20230002', '2', '1001', '2025-11-05', '2025-12-05', 0),
('20230003', '3', '1001', '2025-10-20', '2025-11-20', 2),
('20230004', '4', '1002', '2025-11-10', '2025-12-10', 0),
('20230005', '5', '1006', '2025-11-15', '2025-12-15', 0),
('20230006', '7', '1005', '2025-10-25', '2025-11-25', 2),
('20230007', '9', '1002', '2025-11-20', '2025-12-20', 0),
('20230008', '1', '1005', '2025-10-18', '2025-11-18', 1),
('20230009', '6', '1003', '2025-11-22', '2025-12-22', 0),
('20230010', '11', '1004', '2025-11-25', '2025-12-25', 0),
('20230011', '13', '1007', '2025-09-15', '2025-10-15', 2),
('20230012', '15', '1008', '2025-11-28', '2025-12-28', 0),
('20230013', '17', '1009', '2025-11-30', '2025-12-30', 0),
('20230014', '19', '1010', '2025-12-01', '2026-01-01', 0),
('20230015', '2', '1011', '2025-12-02', '2026-01-02', 0),
('20230016', '4', '1003', '2025-10-15', '2025-11-15', 1),
('20230017', '8', '1009', '2025-09-01', '2025-10-01', 2),
('20230018', '12', '1007', '2025-08-20', '2025-09-20', 2),
('20230019', '14', '1010', '2025-10-05', '2025-11-05', 1),
('20230020', '16', '1012', '2025-12-03', '2026-01-03', 0),
('20230021', '18', '1004', '2025-10-20', '2025-11-20', 1),
('20230022', '20', '1006', '2025-11-28', '2025-12-28', 0);

-- 插入归还记录数据 (10条)
INSERT INTO returnTable (returnId, borrowId, returnDate, overDays, fine) VALUES
('RT20231201001', '20230008', '2025-12-01', 0, 0),
('RT20231215002', '20230016', '2025-12-15', 5, 2.5),
('RT20231220003', '20230017', '2025-12-20', 0, 0),
('RT20231228004', '20230013', '2025-12-28', 27, 13.5),
('RT20231205005', '20230014', '2025-12-05', 0, 0),
('RT20231210006', '20230009', '2025-12-10', 0, 0),
('RT20231205007', '20230021', '2025-12-05', 0, 0),
('RT20231225008', '20230020', '2025-12-25', 0, 0),
('RT20231215009', '20230015', '2025-12-15', 0, 0),
('RT20231220010', '20230022', '2025-12-20', 0, 0);
