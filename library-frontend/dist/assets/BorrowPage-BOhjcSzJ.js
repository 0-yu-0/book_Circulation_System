import{L as j}from"./Layout-BdsSE8cV.js";import{S as q}from"./SearchForm-aUpadHZH.js";import{_ as z}from"./DataTable-MJnSbYJK.js";import{ay as d,G as h,y as p,H as o,x as k,J as N,z as w,P as e,M as C,L as m,Z as G,c as R,r as f,O as J,ab as Q}from"./vendor_vue-CyXBEfF2.js";import{g as Z}from"./reader-ByGKMhQ5.js";import{f as A,g as K}from"./book-vvh8K-TE.js";import{c as W}from"./borrow-CqHv5Yvu.js";import{Q as X}from"./vendor_misc-Dn7xwPo7.js";import"./index-C-RrEStG.js";import"./vendor_element-DkqkCxjX.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Y={key:0},ee={__name:"ReceiptDialog",props:{visible:Boolean,receipt:Object},emits:["close"],setup(l,{emit:y}){const s=l;function v(){const i=document.createElement("div");i.innerHTML="<h3>借阅凭证</h3>"+(s.receipt?`<div>编号:${s.receipt.borrowId}</div>`:"");const a=window.open("","_blank");if(!a)return alert("无法打开打印窗口");a.document.write(i.innerHTML),a.document.close(),a.print()}return(i,a)=>{const r=d("el-table-column"),u=d("el-table"),S=d("el-button"),g=d("el-dialog");return p(),h(g,{title:"借阅凭证",visible:l.visible,width:"600px"},{footer:o(()=>[e(S,{onClick:a[0]||(a[0]=V=>i.$emit("close"))},{default:o(()=>[...a[1]||(a[1]=[m("关闭",-1)])]),_:1}),e(S,{type:"primary",onClick:v},{default:o(()=>[...a[2]||(a[2]=[m("打印",-1)])]),_:1})]),default:o(()=>[l.receipt?(p(),k("div",Y,[w("p",null,"借阅编号: "+C(l.receipt.borrowId),1),w("p",null,"借阅日期: "+C(l.receipt.borrowDate),1),w("p",null,"应还日期: "+C(l.receipt.dueDate),1),e(u,{data:l.receipt.items},{default:o(()=>[e(r,{prop:"title",label:"书名"}),e(r,{prop:"author",label:"作者"})]),_:1},8,["data"])])):N("",!0)]),_:1},8,["visible"])}}},te=X("borrow",()=>{const l=G({selectedReader:null,selectedBooks:[],step:1});function y(r){l.selectedBooks.find(u=>u.id===r.id)||l.selectedBooks.push(r)}function s(r){l.selectedBooks=l.selectedBooks.filter(u=>u.id!==r)}function v(){l.selectedBooks=[],l.selectedReader=null,l.step=1}function i(r){l.selectedReader=r}const a=R(()=>l.selectedBooks.length);return{state:l,addBook:y,removeBook:s,clearSelection:v,setReader:i,selectedCount:a}}),oe={style:{"margin-top":"16px"}},le={key:0},ae={key:0},ne={key:1},ie={key:2},we={__name:"BorrowPage",setup(l){const y=te(),s=f(1),v=f(""),i=f(null),a=f(""),r=f([]),u=R(()=>y.state.selectedBooks),S=R(()=>u.value.length),g=f(!1),V=f(!1),$=f(null);async function H(){const n=await Z(v.value);n&&n.code===0&&(i.value=n.data)}async function O(){const n=await A({search:a.value});n&&n.code===0&&(r.value=n.data.items)}function T(n){y.addBook(n)}function D(){s.value=Math.max(1,s.value-1)}function E(){s.value=Math.min(3,s.value+1)}async function F(){g.value=!0;try{for(const _ of u.value){const B=await K(_.id);if(!(B&&B.code===0))throw new Error("无法验证图书库存");if(B.data.availableCopies<=0)throw new Error(`《${B.data.title}》库存不足`)}const n={readerId:i.value.id,books:u.value.map(_=>({bookId:_.id,count:1})),borrowDate:new Date().toISOString().slice(0,10),dueDate:""},t=await W(n);t&&t.code===0&&($.value=t.data.receipt||t.data,V.value=!0,y.clearSelection(),window.dispatchEvent(new CustomEvent("borrow-success")))}catch(n){console.error(n),window.alert(n.message||"借阅失败")}finally{g.value=!1}}function P(){V.value=!1}return(n,t)=>{const _=d("el-step"),B=d("el-steps"),L=d("el-input"),b=d("el-button"),I=d("el-form-item"),U=d("el-form"),x=d("el-table-column");return p(),h(j,null,{default:o(()=>{var M;return[e(B,{active:s.value},{default:o(()=>[e(_,{title:"选择读者"}),e(_,{title:"选择图书"}),e(_,{title:"确认借阅"})]),_:1},8,["active"]),w("div",oe,[s.value===1?(p(),k("div",le,[e(U,null,{default:o(()=>[e(I,{label:"读者卡号"},{default:o(()=>[e(L,{modelValue:v.value,"onUpdate:modelValue":t[0]||(t[0]=c=>v.value=c)},null,8,["modelValue"]),e(b,{onClick:H},{default:o(()=>[...t[2]||(t[2]=[m("查询",-1)])]),_:1})]),_:1}),i.value?(p(),k("div",ae,"已选："+C(i.value.name),1)):N("",!0),e(b,{type:"primary",onClick:E,disabled:!i.value},{default:o(()=>[...t[3]||(t[3]=[m("下一步",-1)])]),_:1},8,["disabled"])]),_:1})])):s.value===2?(p(),k("div",ne,[e(q,{onSearch:O},{fields:o(()=>[e(I,null,{default:o(()=>[e(L,{modelValue:a.value,"onUpdate:modelValue":t[1]||(t[1]=c=>a.value=c),placeholder:"书名/作者"},null,8,["modelValue"])]),_:1})]),_:1}),e(z,{data:r.value},{columns:o(()=>[e(x,{prop:"title",label:"书名"}),e(x,{prop:"author",label:"作者"}),e(x,{prop:"availableCopies",label:"在馆数"}),e(x,{label:"操作"},{default:o(({row:c})=>[e(b,{onClick:se=>T(c),disabled:c.availableCopies<=0},{default:o(()=>[...t[4]||(t[4]=[m("加入借书篮",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"]),e(b,{onClick:D},{default:o(()=>[...t[5]||(t[5]=[m("上一步",-1)])]),_:1}),e(b,{type:"primary",onClick:E,disabled:S.value===0},{default:o(()=>[...t[6]||(t[6]=[m("下一步",-1)])]),_:1},8,["disabled"])])):(p(),k("div",ie,[t[9]||(t[9]=w("div",null,"确认借阅",-1)),w("div",null,"读者："+C((M=i.value)==null?void 0:M.name),1),w("ul",null,[(p(!0),k(J,null,Q(u.value,c=>(p(),k("li",{key:c.id},C(c.title),1))),128))]),e(b,{onClick:D},{default:o(()=>[...t[7]||(t[7]=[m("上一步",-1)])]),_:1}),e(b,{type:"primary",loading:g.value,onClick:F},{default:o(()=>[...t[8]||(t[8]=[m("提交借阅",-1)])]),_:1},8,["loading"])]))]),e(ee,{visible:V.value,receipt:$.value,onClose:P},null,8,["visible","receipt"])]}),_:1})}}};export{we as default};
