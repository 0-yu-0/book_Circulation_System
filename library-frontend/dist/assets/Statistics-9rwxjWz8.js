import{L as M}from"./Layout-BGNV5PTI.js";import{D as O}from"./DataTable-BPSVB8sg.js";import{a as $,b as G}from"./statistics-AZdWBwl5.js";import{U as E}from"./vendor_misc-BnRtHUQB.js";import{i as S}from"./echartsHelper-DOxFHT-R.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as N}from"./vendor_element-BfRFdgV9.js";import{r as s,o as H,q as K,Y as R,G as Y,H as c,ay as b,y as j,P as o,z as k,D as J}from"./vendor_vue-DcrwGJHO.js";import"./index-xceKWyYj.js";const Q={style:{"margin-top":"12px"}},X={style:{"text-align":"right","margin-top":"-24px","margin-bottom":"12px"}},Z={__name:"Statistics",setup(ee){function L(e){return e&&(e.title||e.bookTitle||e.book_title||e.bookName||e.name||e.book&&(e.book.title||e.book.name))||"Unknown"}const y=s("popular"),p=s([]),u=s([]),_=s(!1),d=s(1),g=s(10),P=s(0),m=s(0),w=s(null),x=s(null);let f=null,h=null,z=!1;async function v(){try{_.value=!0;const e=await $();e&&e.code===0?(p.value=Array.isArray(e.data)?e.data:e.data.items||[],P.value=p.value.length,console.debug("[Statistics] popularList loaded, count=",p.value.length),B(p.value)):N.error((e==null?void 0:e.message)||"获取热门图书失败");const t=await G({page:d.value,size:g.value});if(t&&t.code===0){const n=t.data||{};Array.isArray(t.data)?(u.value=t.data,m.value=t.data.length):t.data&&Array.isArray(t.data.items)?(u.value=t.data.items,m.value=t.data.total||t.data.items.length):(u.value=Array.isArray(t.data)?t.data:t.data.items||[],m.value=u.value.length),console.debug("[Statistics] overdue loaded, count=",u.value.length,"total=",m.value),y.value==="overdue"&&D(u.value)}}catch(e){console.error("[Statistics] loadData failed:",e),N.error("加载统计数据失败: "+(e.message||e))}finally{_.value=!1}}function U(e){d.value=e,v()}function V(e){g.value=e,d.value=1,v()}function F(e){d.value=e,v()}function W(e){g.value=e,d.value=1,v()}function B(e,t=0){if(f&&f(),f=null,!e||e.length===0){S(w.value,({chart:a})=>({title:{text:"热门图书借阅排行",left:"center"},graphic:[{type:"text",left:"center",top:"middle",style:{text:"暂无数据",fontSize:14,fill:"#999"}}],xAxis:{show:!1},yAxis:{show:!1},series:[]}),{waitOptions:{interval:100,timeout:2e3}}).then(({chart:a,dispose:i})=>{f=i}).catch(a=>console.warn("Failed to init empty bar chart:",a.message));return}const n=10;S(w.value,({chart:a,charLimit:i})=>{const l=e.map(r=>L(r)),C=i||n;return{title:{text:"热门图书借阅排行",left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(r){if(Array.isArray(r)&&r[0]){const A=r[0];return`${A.name}<br/>${A.seriesName}: ${A.value}`}return r.name}},grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},xAxis:[{type:"category",data:l,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:30,formatter:r=>r&&r.length>C?r.slice(0,C)+"...":r}}],yAxis:[{type:"value"}],series:[{name:"借阅次数",type:"bar",barWidth:"60%",data:e.map(r=>r.borrowCount||r.count||0),itemStyle:{color:new E(0,0,0,1,[{offset:0,color:"#83bff6"},{offset:.5,color:"#188df0"},{offset:1,color:"#188df0"}])},emphasis:{itemStyle:{color:new E(0,0,0,1,[{offset:0,color:"#2378f7"},{offset:.7,color:"#2378f7"},{offset:1,color:"#83bff6"}])}}}]}},{waitOptions:{interval:100,timeout:3e3}}).then(({chart:a,dispose:i})=>{f=i}).catch(a=>console.warn("Failed to init bar chart:",a.message)),p.value=e.map(a=>({title:L(a),borrowCount:a.borrowCount||a.count||0}))}function D(e){if(h&&h(),h=null,!e||e.length===0){S(x.value,({chart:t})=>({title:{text:"逾期图书分类统计",left:"center"},graphic:[{type:"text",left:"center",top:"middle",style:{text:"暂无数据",fontSize:14,fill:"#999"}}],series:[]}),{waitOptions:{interval:100,timeout:2e3}}).then(({chart:t,dispose:n})=>{h=n,z=!0}).catch(t=>console.warn("Failed to init empty pie chart:",t.message));return}S(x.value,({chart:t})=>{const n=[...new Set(e.map(l=>l.category).filter(Boolean))],a={};return n.forEach(l=>a[l]=0),e.forEach(l=>{l.category&&(a[l.category]=(a[l.category]||0)+1)}),{title:{text:"逾期图书分类统计",left:"center"},tooltip:{trigger:"item"},legend:{orient:"horizontal",bottom:"bottom"},series:[{name:"逾期数量",type:"pie",radius:["40%","70%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:10,borderColor:"#fff",borderWidth:2},label:{show:!1,position:"center"},emphasis:{label:{show:!0,fontSize:"16",fontWeight:"bold"}},labelLine:{show:!1},data:n.map(l=>({value:Math.max(0,a[l]),name:l}))}]}},{waitOptions:{interval:100,timeout:3e3}}).then(({chart:t,dispose:n})=>{h=n,z=!0}).catch(t=>console.warn("Failed to init pie chart:",t.message))}function I(e){J(()=>{e==="popular"&&w.value?B(p.value):e==="overdue"&&x.value&&!z&&D(u.value)})}return H(y,I),K(()=>{v()}),R(()=>{f&&f(),h&&h()}),(e,t)=>{const n=b("el-card"),a=b("el-table-column"),i=b("el-tab-pane"),l=b("el-badge"),C=b("el-tabs");return j(),Y(M,null,{default:c(()=>[o(C,{modelValue:y.value,"onUpdate:modelValue":t[0]||(t[0]=T=>y.value=T)},{default:c(()=>[o(i,{label:"热门图书",name:"popular"},{default:c(()=>[k("div",Q,[o(n,null,{default:c(()=>[k("div",{ref_key:"barChartContainer",ref:w,class:"chart-container"},null,512)]),_:1}),o(O,{data:p.value,loading:_.value,showSelection:!1,page:d.value,"page-size":g.value,total:P.value,onPageChange:U,onSizeChange:V},{columns:c(()=>[o(a,{prop:"title",label:"书名"}),o(a,{prop:"borrowCount",label:"借阅次数"})]),_:1},8,["data","loading","page","page-size","total"])])]),_:1}),o(i,{label:"逾期未还",name:"overdue"},{default:c(()=>[o(n,{style:{"margin-bottom":"16px"}},{default:c(()=>[k("div",{ref_key:"pieChartContainer",ref:x,class:"chart-container"},null,512)]),_:1}),o(O,{data:u.value,loading:_.value,showSelection:!1,page:d.value,"page-size":g.value,total:m.value,onPageChange:F,onSizeChange:W},{columns:c(()=>[o(a,{prop:"borrowId",label:"借阅编号"}),o(a,{prop:"bookTitle",label:"书名"}),o(a,{prop:"readerName",label:"读者姓名"}),o(a,{prop:"dueDate",label:"应还日期"}),o(a,{prop:"overdueDays",label:"逾期天数"}),o(a,{prop:"category",label:"分类"})]),_:1},8,["data","loading","page","page-size","total"]),k("div",X,[o(l,{value:m.value,class:"item"},null,8,["value"])])]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},ce=q(Z,[["__scopeId","data-v-8a0313b0"]]);export{ce as default};
