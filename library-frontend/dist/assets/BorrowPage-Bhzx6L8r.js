import{L as Re}from"./Layout-BGNV5PTI.js";import{S as se}from"./SearchForm-BReYfrNJ.js";import{D as ne}from"./DataTable-BPSVB8sg.js";import{ay as v,G as O,y as r,H as a,x as p,J as re,z as o,M as f,O as G,ab as H,P as t,L as _,Z as Ve,c as J,r as u,q as $e,o as ie,aZ as Pe,u as N}from"./vendor_vue-DcrwGJHO.js";import{f as De}from"./reader-DiP4nMq6.js";import{g as Ee,f as Ie}from"./book-CtD6eXrW.js";import{c as Me}from"./borrow-ByKR0lJe.js";import{Q as Ne}from"./vendor_misc-BnRtHUQB.js";import{E as S,b as Oe,e as Te,f as Le,r as Ue}from"./vendor_element-BfRFdgV9.js";import{_ as je}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-xceKWyYj.js";const Fe={key:0,id:"print-ticket",class:"ticket"},Ze={class:"meta"},qe={class:"meta"},Ae={class:"meta"},Ge={class:"left"},He={__name:"ReceiptDialog",props:{visible:Boolean,receipt:Object},emits:["update:visible"],setup(d,{emit:k}){function x(){window.print()}return(m,s)=>{const C=v("el-button"),z=v("el-dialog");return r(),O(z,{title:"借阅凭证",visible:d.visible,width:"600px",onClose:s[1]||(s[1]=n=>m.$emit("update:visible",!1))},{footer:a(()=>[t(C,{onClick:s[0]||(s[0]=n=>m.$emit("update:visible",!1))},{default:a(()=>[...s[6]||(s[6]=[_("关闭",-1)])]),_:1}),t(C,{type:"primary",onClick:x},{default:a(()=>[...s[7]||(s[7]=[_("打印",-1)])]),_:1})]),default:a(()=>[d.receipt?(r(),p("div",Fe,[s[2]||(s[2]=o("div",{class:"title"},"图书借阅凭证",-1)),o("div",Ze,"借阅时间："+f(d.receipt.borrowDate),1),o("div",qe,"应还时间："+f(d.receipt.dueDate),1),o("div",Ae,"借阅编号："+f(d.receipt.borrowId),1),s[3]||(s[3]=o("div",{class:"separator"},null,-1)),(r(!0),p(G,null,H(d.receipt.items,(n,c)=>(r(),p("div",{class:"book-row",key:c},[o("span",Ge,f(n.bookTitle)+" - "+f(n.bookAuthor),1)]))),128)),s[4]||(s[4]=o("div",{class:"separator"},null,-1)),s[5]||(s[5]=o("div",{class:"footer"},"请妥善保管此凭证，按时归还图书",-1))])):re("",!0)]),_:1},8,["visible"])}}},Je=Ne("borrow",()=>{const d=Ve({selectedReader:null,selectedBooks:[],step:1});function k(n,c=1){const h=d.selectedBooks.find(B=>B.id===(n.id??n.bookId));h?h.count=Math.max(0,(h.count||0)+c):d.selectedBooks.push(Object.assign({},{id:n.id??n.bookId,title:n.title??n.bookName,count:c},n))}function x(n){d.selectedBooks=d.selectedBooks.filter(c=>c.id!==n)}function m(n,c){const h=d.selectedBooks.find(B=>B.id===n);h&&(h.count=Math.max(0,Number(c)||0),h.count===0&&x(n))}function s(){d.selectedBooks=[],d.selectedReader=null,d.step=1}function C(n){d.selectedReader=n}const z=J(()=>d.selectedBooks.reduce((n,c)=>n+(c.count||0),0));return{state:d,addBook:k,removeBook:x,setCount:m,clearSelection:s,setReader:C,selectedCount:z}}),Qe={style:{"margin-top":"16px"}},Ke={key:0},We={class:"reader-info"},Xe={class:"no-reader-placeholder"},Ye={key:1},et={class:"step-buttons"},tt={key:0,class:"basket-container"},at={class:"basket-content"},lt={class:"basket-items"},ot={key:0,class:"empty-basket"},st={key:1,class:"basket-items-list"},nt={class:"book-info"},it={class:"book-title"},rt={class:"book-author"},dt={class:"book-actions"},ut={class:"basket-footer"},ct={class:"basket-preview"},vt={class:"basket-preview-header"},pt={class:"basket-preview-content"},ft={key:0,class:"preview-empty"},mt={key:1},_t={class:"preview-item-title"},bt={class:"preview-item-count"},gt={key:0,class:"preview-more"},kt={class:"basket-preview-footer"},ht={key:2},yt={class:"step-buttons"},wt={__name:"BorrowPage",setup(d){const k=Je(),x=Pe(),m=u(1);u("");const s=u(null),C=u(""),z=u([]),n=u(!1),c=u(!1),h=u([]),B=u(""),R=u(1),T=u(10),Q=u(0),V=u(1),L=u(10),K=u(0),de={0:"正常",1:"挂失",2:"注销"},b=J(()=>k.state.selectedBooks),D=J(()=>b.value.length),U=u(!1),j=u(!1),W=u(null);$e(()=>{E()}),ie(()=>x.currentRoute.value,(l,e)=>{e.path==="/borrow"&&l.path!=="/borrow"&&(m.value=1,Z())},{immediate:!1});function F(){c.value=!c.value}async function E(){n.value=!0;try{const l={page:R.value,size:T.value,search:B.value},e=await De(l);e&&e.code===0?(h.value=e.data.items||[],Q.value=e.data.total||0):S.error((e==null?void 0:e.message)||"获取读者列表失败")}catch(l){S.error("获取读者列表失败: "+(l.message||l))}finally{n.value=!1}}function ue(l){R.value=l,E()}function ce(l){T.value=l,R.value=1,E()}async function ve(){R.value=1,await E()}function pe(){B.value="",R.value=1,E()}function fe(l){s.value=l,k.setReader(l)}async function I(){n.value=!0;try{const l={page:V.value,size:L.value,search:C.value},e=await Ie(l);e&&e.code===0?(z.value=(e.data.items||[]).filter(y=>y.availableCopies>0),K.value=e.data.total||0):S.error((e==null?void 0:e.message)||"获取图书列表失败")}catch(l){S.error("获取图书列表失败: "+(l.message||l))}finally{n.value=!1}}function me(l){V.value=l,I()}function _e(l){L.value=l,V.value=1,I()}async function be(){V.value=1,await I()}function ge(){C.value="",V.value=1,I()}ie(m,l=>{l===2&&I()});function ke(l){k.addBook(l),c.value=!0}function X(l){k.removeBook(l)}function Z(){k.clearSelection()}function he(l,e){e===0?X(l):k.setCount(l,e)}function Y(){m.value=Math.max(1,m.value-1),Z()}function ee(){m.value=Math.min(3,m.value+1)}async function ye(){U.value=!0;try{for(const y of b.value){const $=await Ee(y.id);if(!($&&$.code===0))throw new Error("无法验证图书库存");if($.data.availableCopies<=0)throw new Error(`《${$.data.title}》库存不足`)}const l={readerId:s.value.id??s.value.readerId,books:b.value.map(y=>({bookId:y.id,count:y.count})),borrowDate:new Date().toISOString().slice(0,10),dueDate:""},e=await Me(l);e&&e.code===0?(W.value=e.data.receipt||e.data||{borrowIds:e.data.borrowIds},j.value=!0,k.clearSelection(),window.dispatchEvent(new CustomEvent("borrow-success")),S.success("借阅成功")):S.error((e==null?void 0:e.message)||"借阅失败")}catch(l){console.error(l),S.error(l.message||"借阅失败")}finally{U.value=!1}}function we(){j.value=!1}return(l,e)=>{const y=v("el-step"),$=v("el-steps"),te=v("el-input"),ae=v("el-form-item"),w=v("el-table-column"),g=v("el-button"),M=v("el-col"),q=v("el-descriptions-item"),Ce=v("el-descriptions"),le=v("el-card"),Be=v("el-empty"),A=v("el-row"),Se=v("el-icon"),xe=v("el-input-number"),ze=v("el-table");return r(),O(Re,null,{default:a(()=>{var oe;return[t($,{active:m.value},{default:a(()=>[t(y,{title:"选择读者"}),t(y,{title:"选择图书"}),t(y,{title:"确认借阅"})]),_:1},8,["active"]),o("div",Qe,[m.value===1?(r(),p("div",Ke,[t(A,{gutter:20},{default:a(()=>[t(M,{span:24},{default:a(()=>[t(se,{onSearch:ve,onReset:pe},{fields:a(()=>[t(ae,null,{default:a(()=>[t(te,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=i=>B.value=i),placeholder:"读者姓名/卡号"},null,8,["modelValue"])]),_:1})]),_:1}),t(A,{gutter:20},{default:a(()=>[t(M,{span:16},{default:a(()=>[t(ne,{data:h.value,loading:n.value,"show-selection":!1,total:Q.value,page:R.value,"page-size":T.value,onPageChange:ue,onSizeChange:ce},{columns:a(()=>[t(w,{prop:"name",label:"姓名"}),t(w,{prop:"id",label:"卡号"}),t(w,{label:"操作"},{default:a(({row:i})=>[t(g,{onClick:P=>fe(i)},{default:a(()=>[...e[2]||(e[2]=[_("选择",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data","loading","total","page","page-size"])]),_:1}),t(M,{span:8},{default:a(()=>[s.value?(r(),O(le,{key:0,class:"selected-reader"},{header:a(()=>[...e[3]||(e[3]=[o("div",{class:"clearfix"},[o("span",null,"已选读者")],-1)])]),default:a(()=>[o("div",We,[t(Ce,{column:1,size:"small",border:""},{default:a(()=>[t(q,{label:"姓名"},{default:a(()=>[_(f(s.value.name),1)]),_:1}),t(q,{label:"卡号"},{default:a(()=>[_(f(s.value.id),1)]),_:1}),t(q,{label:"状态"},{default:a(()=>[_(f(de[s.value.status]||"正常"),1)]),_:1})]),_:1})]),t(g,{type:"primary",onClick:ee,disabled:!s.value,style:{"margin-top":"15px",width:"100%"}},{default:a(()=>[...e[4]||(e[4]=[_("下一步",-1)])]),_:1},8,["disabled"])]),_:1})):(r(),O(le,{key:1,class:"no-selected-reader"},{header:a(()=>[...e[5]||(e[5]=[o("div",{class:"clearfix"},[o("span",null,"已选读者")],-1)])]),default:a(()=>[o("div",Xe,[t(Be,{description:"暂未选择读者","image-size":80})])]),_:1}))]),_:1})]),_:1})]),_:1})]),_:1})])):m.value===2?(r(),p("div",Ye,[t(A,{gutter:20},{default:a(()=>[t(M,{span:c.value?16:22},{default:a(()=>[t(se,{onSearch:be,onReset:ge},{fields:a(()=>[t(ae,null,{default:a(()=>[t(te,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=i=>C.value=i),placeholder:"书名/作者"},null,8,["modelValue"])]),_:1})]),_:1}),t(ne,{data:z.value,loading:n.value,"show-selection":!1,total:K.value,page:V.value,"page-size":L.value,onPageChange:me,onSizeChange:_e,"fixed-height":!0},{columns:a(()=>[t(w,{prop:"title",label:"书名"}),t(w,{prop:"author",label:"作者"}),t(w,{prop:"availableCopies",label:"在馆数"}),t(w,{label:"操作"},{default:a(({row:i})=>[t(g,{onClick:P=>ke(i),disabled:i.availableCopies<=0},{default:a(()=>[...e[6]||(e[6]=[_("加入借书篮",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data","loading","total","page","page-size"]),o("div",et,[t(g,{onClick:Y},{default:a(()=>[...e[7]||(e[7]=[_("上一步",-1)])]),_:1}),t(g,{type:"primary",onClick:ee,disabled:D.value===0},{default:a(()=>[...e[8]||(e[8]=[_("下一步",-1)])]),_:1},8,["disabled"])])]),_:1},8,["span"]),t(M,{span:c.value?8:2},{default:a(()=>[c.value?(r(),p("div",tt,[o("div",{class:"basket-header",onClick:F},[o("span",null,"借书篮 ("+f(D.value)+")",1),t(Se,null,{default:a(()=>[t(N(Oe))]),_:1})]),o("div",at,[o("div",lt,[b.value.length===0?(r(),p("div",ot," 借书篮为空 ")):(r(),p("div",st,[(r(!0),p(G,null,H(b.value,i=>(r(),p("div",{key:i.id,class:"basket-item"},[o("div",nt,[o("div",it,f(i.title),1),o("div",rt,f(i.author),1)]),o("div",dt,[t(xe,{modelValue:i.count,"onUpdate:modelValue":P=>i.count=P,min:0,max:i.availableCopies,size:"small",onChange:P=>he(i.id,P)},null,8,["modelValue","onUpdate:modelValue","max","onChange"]),t(g,{type:"danger",icon:"Delete",size:"small",onClick:P=>X(i.id)},null,8,["onClick"])])]))),128))]))]),o("div",ut,[t(g,{type:"danger",onClick:Z,disabled:b.value.length===0},{default:a(()=>[...e[9]||(e[9]=[_("清空借书篮",-1)])]),_:1},8,["disabled"])])])])):(r(),p("div",{key:1,class:"basket-toggle",onClick:F},[t(N(Te),{placement:"left",trigger:"hover",width:200,"popper-class":"basket-popover"},{reference:a(()=>[t(N(Le),{value:D.value,max:99,hidden:D.value===0,class:"basket-badge"},{default:a(()=>[t(g,{type:"primary",icon:N(Ue),circle:"",size:"large"},null,8,["icon"])]),_:1},8,["value","hidden"])]),default:a(()=>[o("div",ct,[o("div",vt,[e[10]||(e[10]=o("strong",null,"借书篮预览",-1)),o("span",null,"("+f(D.value)+")",1)]),o("div",pt,[b.value.length===0?(r(),p("div",ft," 借书篮为空 ")):(r(),p("div",mt,[(r(!0),p(G,null,H(b.value.slice(0,3),i=>(r(),p("div",{key:i.id,class:"preview-item"},[o("div",_t,f(i.title),1),o("div",bt,"数量: "+f(i.count),1)]))),128)),b.value.length>3?(r(),p("div",gt," 还有 "+f(b.value.length-3)+" 本书... ",1)):re("",!0)]))]),o("div",kt,[t(g,{type:"primary",size:"small",onClick:F},{default:a(()=>[...e[11]||(e[11]=[_("查看借书篮",-1)])]),_:1})])])]),_:1})]))]),_:1},8,["span"])]),_:1})])):(r(),p("div",ht,[e[14]||(e[14]=o("div",null,"确认借阅",-1)),o("div",null,"读者："+f((oe=s.value)==null?void 0:oe.name),1),t(ze,{data:b.value,style:{width:"100%"}},{default:a(()=>[t(w,{prop:"title",label:"书名"}),t(w,{prop:"author",label:"作者"}),t(w,{prop:"count",label:"数量"})]),_:1},8,["data"]),o("div",yt,[t(g,{onClick:Y},{default:a(()=>[...e[12]||(e[12]=[_("上一步",-1)])]),_:1}),t(g,{type:"primary",loading:U.value,onClick:ye},{default:a(()=>[...e[13]||(e[13]=[_("提交借阅",-1)])]),_:1},8,["loading"])])]))]),t(He,{visible:j.value,receipt:W.value,onClose:we},null,8,["visible","receipt"])]}),_:1})}}},It=je(wt,[["__scopeId","data-v-fb523bfa"]]);export{It as default};
