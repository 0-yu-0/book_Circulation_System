import{L as A}from"./Layout-BGNV5PTI.js";import{g as P,a as R}from"./statistics-AZdWBwl5.js";import"./vendor_misc-BnRtHUQB.js";import{i as E}from"./echartsHelper-DOxFHT-R.js";import{c as S,u as U,r as V,d as $,E as x,t as j,p as q}from"./vendor_element-BfRFdgV9.js";import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as f,aB as h,q as H,Y as z,G as B,H as s,D as I,ay as p,y as w,P as n,x as K,O as W,ab as X,z as l,C as Y,K as J,M as D,L as F,u as M}from"./vendor_vue-DcrwGJHO.js";import"./index-xceKWyYj.js";const Q={class:"kpi-content"},Z={class:"kpi-title"},ee={class:"kpi-value"},te={class:"card-header"},ae={class:"card-header"},oe={__name:"Dashboard",setup(se){const r=f([{title:"总图书",value:0,icon:h(S),iconClass:"icon-blue"},{title:"总读者",value:0,icon:h(U),iconClass:"icon-green"},{title:"在借",value:0,icon:h(V),iconClass:"icon-orange"},{title:"今日借书",value:0,icon:h($),iconClass:"icon-red"}]),L=f([]),v=f(!1),g=f(null),b=f(null);let c=null,u=null,C=null,y=null;function N(e){return e&&(e.title||e.bookTitle||e.book_title||e.bookName||e.name||e.book&&(e.book.title||e.book.name))||"Unknown"}async function k(){v.value=!0;try{const e=await P();if(e&&e.code===0){const a=e.data;r.value[0].value=a.totalBooks,r.value[1].value=a.totalReaders,r.value[2].value=a.borrowedCount||a.totalBorrows||0,r.value[3].value=a.todayBorrows||0}else x.error((e==null?void 0:e.message)||"获取统计数据失败");const t=await R(8);t&&t.code===0?(L.value=t.data,v.value=!1,await I(),O(L.value)):x.error((t==null?void 0:t.message)||"获取热门图书失败")}catch(e){console.error(e),x.error("加载数据失败: "+(e.message||"未知错误"))}finally{v.value=!1}}function O(e){C&&C(),y&&y(),g.value&&E(g.value,({chart:t,charLimit:a})=>{const i=e.map(o=>N(o));return{title:{text:"热门图书借阅排行",left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(o){if(Array.isArray(o)&&o[0]){const d=o[0];return`${d.name}<br/>${d.seriesName}: ${d.value}`}return o.name}},grid:{left:"3%",right:"4%",bottom:"15%",containLabel:!0},xAxis:{type:"category",data:i,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:30,formatter:function(o){return o?o.length>a?o.slice(0,a)+"...":o:""}}},yAxis:{type:"value"},series:[{type:"bar",data:e.map(o=>o.borrowCount||0),itemStyle:{color:"#409EFF"}}]}},{waitOptions:{interval:100,timeout:5e3},labelsCount:e.length}).then(({chart:t,dispose:a})=>{c=t,C=a}).catch(t=>{console.warn("Failed to init bar chart:",t.message)}),b.value&&E(b.value,({chart:t})=>{const a=r.value[0].value-r.value[2].value;return{title:{text:"借阅状态分布",left:"center"},tooltip:{trigger:"item"},legend:{orient:"vertical",left:"left"},series:[{type:"pie",radius:"50%",data:[{value:Math.max(0,r.value[2].value),name:"在借图书"},{value:Math.max(0,a),name:"在馆图书"}],emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0,0,0,0.5)"}}}]}},{waitOptions:{interval:100,timeout:3e3}}).then(({chart:t,dispose:a})=>{u=t,y=a}).catch(t=>{console.warn("Failed to init pie chart:",t.message)})}return H(()=>{k(),window.addEventListener("borrow-success",k);const e=()=>{c&&c.resize(),u&&u.resize()};window.addEventListener("resize",e),z(()=>{window.removeEventListener("resize",e)})}),z(()=>{window.removeEventListener("borrow-success",k),c&&c.dispose(),u&&u.dispose()}),(e,t)=>{const a=p("el-icon"),i=p("el-card"),_=p("el-col"),o=p("el-row"),d=p("el-skeleton");return w(),B(A,null,{default:s(()=>[n(d,{loading:v.value,animated:"",rows:4},{default:s(()=>[n(o,{gutter:16,justify:"space-between"},{default:s(()=>[(w(!0),K(W,null,X(r.value,(m,T)=>(w(),B(_,{xs:24,sm:12,md:12,lg:6,key:T},{default:s(()=>[n(i,{class:"kpi-card",shadow:"hover"},{default:s(()=>[l("div",{class:Y(["kpi-icon",m.iconClass])},[n(a,{size:"24"},{default:s(()=>[(w(),B(J(m.icon)))]),_:2},1024)],2),l("div",Q,[l("div",Z,D(m.title),1),l("div",ee,D(m.value),1)])]),_:2},1024)]),_:2},1024))),128))]),_:1}),n(o,{gutter:16,style:{"margin-top":"16px"}},{default:s(()=>[n(_,{xs:24,sm:24,md:16},{default:s(()=>[n(i,{shadow:"hover"},{header:s(()=>[l("div",te,[n(a,null,{default:s(()=>[n(M(j))]),_:1}),t[0]||(t[0]=F(" 热门图书 ",-1))])]),default:s(()=>[l("div",{ref_key:"chartContainer",ref:g,class:"chart-container"},null,512)]),_:1})]),_:1}),n(_,{xs:24,sm:24,md:8},{default:s(()=>[n(i,{shadow:"hover"},{header:s(()=>[l("div",ae,[n(a,null,{default:s(()=>[n(M(q))]),_:1}),t[1]||(t[1]=F(" 借阅统计 ",-1))])]),default:s(()=>[l("div",{ref_key:"pieChartContainer",ref:b,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1})]),_:1},8,["loading"])]),_:1})}}},pe=G(oe,[["__scopeId","data-v-362ec315"]]);export{pe as default};
