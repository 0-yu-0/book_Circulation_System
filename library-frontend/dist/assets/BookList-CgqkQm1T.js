import{L as A}from"./Layout-BGNV5PTI.js";import{D as J}from"./DataTable-BPSVB8sg.js";import{S as K}from"./SearchForm-BReYfrNJ.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as d,Z as Q,o as W,ay as m,G as E,y as O,H as n,P as o,L as g,M as ee,u as oe,q as le,Y as te,aZ as ae,z as R}from"./vendor_vue-DcrwGJHO.js";import{f as ne,c as Y,d as se,u as ue}from"./book-CtD6eXrW.js";import{p as ie,e as re}from"./csv-D30QsHdy.js";import{E as v}from"./vendor_element-BfRFdgV9.js";import"./index-xceKWyYj.js";import"./vendor_misc-BnRtHUQB.js";const pe={__name:"BookForm",props:{visible:Boolean,book:Object},emits:["save","cancel"],setup(x,{emit:I}){const k=x,V=I,h=d(null),c=d(!1),y=k.book?"edit":"create",t=Q({id:null,title:"",author:"",isbn:"",publisher:"",publishDate:"",category:"",location:"",totalCopies:1}),_={title:[{required:!0,message:"请输入书名",trigger:"blur"}],author:[{required:!0,message:"请输入作者",trigger:"blur"}],isbn:[{required:!0,message:"请输入ISBN",trigger:"blur"},{pattern:/^(?:\d{9}[\dXx]|\d{13})$/,message:"ISBN 格式错误（支持 ISBN-10/13）",trigger:"blur"}],totalCopies:[{type:"number",min:0,message:"数量不能为负"}]};W(()=>k.book,f=>{f?Object.assign(t,f):Object.assign(t,{id:null,title:"",author:"",isbn:"",publisher:"",publishDate:"",category:"",location:"",totalCopies:1})});function D(){h.value.validate(f=>{f&&(c.value=!0,t.publishDate&&t.publishDate instanceof Date&&(t.publishDate=t.publishDate.toISOString().slice(0,10)),setTimeout(()=>{V("save",{...t}),c.value=!1},500))})}return(f,u)=>{const r=m("el-input"),b=m("el-form-item"),N=m("el-date-picker"),U=m("el-input-number"),$=m("el-form"),B=m("el-button"),L=m("el-dialog");return O(),E(L,{title:oe(y)==="edit"?"编辑图书":"新增图书","model-value":x.visible,width:"600px",onClose:u[9]||(u[9]=i=>f.$emit("cancel"))},{footer:n(()=>[o(B,{onClick:u[8]||(u[8]=i=>f.$emit("cancel")),class:"form-button"},{default:n(()=>[...u[10]||(u[10]=[g("取消",-1)])]),_:1}),o(B,{type:"primary",onClick:D,class:"form-button",loading:c.value},{default:n(()=>[g(ee(c.value?"保存中...":"保存"),1)]),_:1},8,["loading"])]),default:n(()=>[o($,{model:t,rules:_,ref_key:"formRef",ref:h,"label-width":"100px",class:"book-form"},{default:n(()=>[o(b,{label:"书名",prop:"title"},{default:n(()=>[o(r,{modelValue:t.title,"onUpdate:modelValue":u[0]||(u[0]=i=>t.title=i),placeholder:"请输入书名"},null,8,["modelValue"])]),_:1}),o(b,{label:"作者",prop:"author"},{default:n(()=>[o(r,{modelValue:t.author,"onUpdate:modelValue":u[1]||(u[1]=i=>t.author=i),placeholder:"请输入作者"},null,8,["modelValue"])]),_:1}),o(b,{label:"ISBN",prop:"isbn"},{default:n(()=>[o(r,{modelValue:t.isbn,"onUpdate:modelValue":u[2]||(u[2]=i=>t.isbn=i),placeholder:"请输入ISBN"},null,8,["modelValue"])]),_:1}),o(b,{label:"出版社",prop:"publisher"},{default:n(()=>[o(r,{modelValue:t.publisher,"onUpdate:modelValue":u[3]||(u[3]=i=>t.publisher=i),placeholder:"请输入出版社"},null,8,["modelValue"])]),_:1}),o(b,{label:"出版日期",prop:"publishDate"},{default:n(()=>[o(N,{modelValue:t.publishDate,"onUpdate:modelValue":u[4]||(u[4]=i=>t.publishDate=i),type:"date",placeholder:"选择日期",style:{width:"100%"},"value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),o(b,{label:"分类",prop:"category"},{default:n(()=>[o(r,{modelValue:t.category,"onUpdate:modelValue":u[5]||(u[5]=i=>t.category=i),placeholder:"请输入分类"},null,8,["modelValue"])]),_:1}),o(b,{label:"位置",prop:"location"},{default:n(()=>[o(r,{modelValue:t.location,"onUpdate:modelValue":u[6]||(u[6]=i=>t.location=i),placeholder:"请输入位置"},null,8,["modelValue"])]),_:1}),o(b,{label:"总册数",prop:"totalCopies"},{default:n(()=>[o(U,{modelValue:t.totalCopies,"onUpdate:modelValue":u[7]||(u[7]=i=>t.totalCopies=i),min:0,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","model-value"])}}},de=q(pe,[["__scopeId","data-v-a3cd4950"]]),me={class:"toolbar"},ce={class:"actions"},fe={__name:"BookList",setup(x){const I=ae(),k=d({search:""}),V=d([]),h=d(0),c=d(1),y=d(10),t=d(!1),w=d(null),_=d(!1),D=d(null),f=d(!1),u=d([]);async function r(){f.value=!0;try{const l=await ne({page:c.value,size:y.value,search:k.value.search});l&&l.code===0&&(V.value=l.data.items,h.value=l.data.total)}catch(l){v.error("获取图书列表失败: "+(l.message||l))}finally{f.value=!1}}le(()=>{r(),window.addEventListener("borrow-success",r)});function b(){c.value=1,r()}function N(l){c.value=l,r()}function U(l){y.value=l,c.value=1,r()}function $(l){u.value=l}function B(){D.value=null,_.value=!0}function L(l){D.value={...l},_.value=!0}function i(l){I.push(`/books/${l.id}`)}function T(l){w.value=l,t.value=!0}async function j(){if(w.value)try{const l=await se(w.value.id);l&&l.code===0?(t.value=!1,v.success("删除成功"),r()):v.error((l==null?void 0:l.message)||"删除失败")}catch(l){v.error("删除失败: "+(l.message||l))}}async function P(l){try{let e;l.id?(e=await ue(l.id,l),e&&e.code===0&&(_.value=!1,r(),v.success("保存成功"))):(e=await Y(l),e&&e.code===0&&(_.value=!1,r(),v.success("创建成功"))),e&&e.code!==0&&v.error(e.message||"操作失败")}catch(e){console.error("保存图书失败:",e),v.error("保存失败: "+(e.message||"未知错误"))}}function Z(){_.value=!1}async function G(){const l=["ID","书名","作者","出版社","ISBN","出版日期","分类","位置","总册数","在馆数"],e=V.value.map(p=>[p.id,p.title,p.author,p.publisher,p.isbn,p.publishDate,p.category,p.location,p.totalCopies,p.availableCopies]);re(`books_${Date.now()}.csv`,l,e)}async function H(l){try{const{headers:e,rows:p}=await ie(l),z=a=>e.findIndex(S=>S.toLowerCase().includes(a)),s=(a,S)=>a[z(S)]??"",F=p.map(a=>({title:s(a,"书名")||s(a,"title"),author:s(a,"作者")||s(a,"author"),publisher:s(a,"出版社")||s(a,"publisher"),isbn:s(a,"isbn")||s(a,"ISBN"),publishDate:s(a,"出版")||s(a,"publishDate"),category:s(a,"分类")||s(a,"category"),location:s(a,"位置")||s(a,"location"),totalCopies:Number(s(a,"总册数")||s(a,"totalCopies")||1)}));for(const a of F)await Y(a);v.success("导入成功"),r()}catch(e){v.error("导入失败: "+(e.message||e))}return!1}function X(){k.value.search="",c.value=1,y.value=10,r()}return te(()=>{window.removeEventListener("borrow-success",r)}),(l,e)=>{const p=m("el-input"),z=m("el-form-item"),s=m("el-button"),F=m("el-upload"),a=m("el-table-column"),S=m("el-dialog");return O(),E(A,null,{default:n(()=>[R("div",me,[o(K,{onSearch:b,onReset:X},{fields:n(()=>[o(z,null,{default:n(()=>[o(p,{modelValue:k.value.search,"onUpdate:modelValue":e[0]||(e[0]=C=>k.value.search=C),placeholder:"书名/作者/ISBN"},null,8,["modelValue"])]),_:1})]),_:1}),R("div",ce,[o(F,{"show-file-list":!1,"before-upload":H},{default:n(()=>[o(s,null,{default:n(()=>[...e[3]||(e[3]=[g("导入 CSV",-1)])]),_:1})]),_:1}),o(s,{onClick:G},{default:n(()=>[...e[4]||(e[4]=[g("导出 CSV",-1)])]),_:1}),o(s,{type:"primary",onClick:B},{default:n(()=>[...e[5]||(e[5]=[g("新增图书",-1)])]),_:1})])]),o(J,{data:V.value,total:h.value,page:c.value,"page-size":y.value,onPageChange:N,onSizeChange:U,loading:f.value,onSelectionChange:$},{columns:n(()=>[o(a,{prop:"title",label:"书名"}),o(a,{prop:"author",label:"作者"}),o(a,{prop:"publisher",label:"出版社"}),o(a,{prop:"publishDate",label:"出版日期"}),o(a,{prop:"category",label:"分类"}),o(a,{prop:"availableCopies",label:"在馆数"}),o(a,{label:"操作"},{default:n(({row:C})=>[o(s,{type:"text",onClick:M=>L(C)},{default:n(()=>[...e[6]||(e[6]=[g("编辑",-1)])]),_:1},8,["onClick"]),o(s,{type:"text",onClick:M=>T(C)},{default:n(()=>[...e[7]||(e[7]=[g("删除",-1)])]),_:1},8,["onClick"]),o(s,{type:"text",onClick:M=>i(C)},{default:n(()=>[...e[8]||(e[8]=[g("详情",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data","total","page","page-size","loading"]),o(S,{title:"确认删除",modelValue:t.value,"onUpdate:modelValue":e[2]||(e[2]=C=>t.value=C)},{footer:n(()=>[o(s,{onClick:e[1]||(e[1]=C=>t.value=!1)},{default:n(()=>[...e[9]||(e[9]=[g("取 消",-1)])]),_:1}),o(s,{type:"primary",onClick:j},{default:n(()=>[...e[10]||(e[10]=[g("确 定",-1)])]),_:1})]),default:n(()=>[e[11]||(e[11]=R("span",null,"确定要删除这本书吗？",-1))]),_:1},8,["modelValue"]),o(de,{visible:_.value,book:D.value,onSave:P,onCancel:Z},null,8,["visible","book"])]),_:1})}}},Se=q(fe,[["__scopeId","data-v-f4b3327f"]]);export{Se as default};
