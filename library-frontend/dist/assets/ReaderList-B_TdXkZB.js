import{L as K}from"./Layout-BGNV5PTI.js";import{D as Q}from"./DataTable-BPSVB8sg.js";import{S as W}from"./SearchForm-BReYfrNJ.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as i,c as O,Z as ee,o as le,ay as s,G as E,y as M,H as o,P as l,L as c,M as te,q as oe,a_ as ae,aZ as ne,z as F}from"./vendor_vue-DcrwGJHO.js";import{g as re,f as ue,d as se,u as ie,c as de}from"./reader-DiP4nMq6.js";import{p as me,e as pe}from"./csv-D30QsHdy.js";import{E as x}from"./vendor_element-BfRFdgV9.js";import"./index-xceKWyYj.js";import"./vendor_misc-BnRtHUQB.js";const ce={__name:"ReaderForm",props:{modelValue:Boolean,visible:Boolean,reader:Object,data:Object},emits:["save","cancel","update:modelValue"],setup(I,{emit:D}){const p=I,d=D,R=i(null),V=i(!1),v=O({get(){return typeof p.modelValue=="boolean"?p.modelValue:!!p.visible},set(u){d("update:modelValue",u)}}),k=O(()=>{const u=p.reader||p.data;return u&&(u.id||u.id===0)?"edit":"create"}),a=ee({id:null,name:"",idType:"身份证",idNumber:"",phone:"",borrowLimit:5}),S=/^(?:\d{15}|\d{17}[\dXx])$/,b={name:[{required:!0,message:"请输入姓名",trigger:"blur"}],idNumber:[{required:!0,message:"请输入证件号",trigger:"blur"},{validator:(u,r,_)=>{a.idType==="身份证"&&r&&!S.test(r)?_(new Error("证件号格式错误")):_()},trigger:"blur"}],phone:[{required:!0,message:"请输入电话",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"手机号码格式错误",trigger:"blur"}]};le(()=>p.reader||p.data,u=>{u&&Object.keys(u).length?Object.assign(a,u):Object.assign(a,{id:null,name:"",idType:"身份证",idNumber:"",phone:"",borrowLimit:5})});function T(){d("update:modelValue",!1),d("cancel")}function q(){d("update:modelValue",!1),d("cancel")}function f(){R.value.validate(u=>{u&&(V.value=!0,setTimeout(()=>{d("save",{...a}),V.value=!1,d("update:modelValue",!1)},500))})}return(u,r)=>{const _=s("el-input"),w=s("el-form-item"),N=s("el-option"),U=s("el-select"),$=s("el-input-number"),z=s("el-form"),L=s("el-button"),B=s("el-dialog");return M(),E(B,{title:k.value==="edit"?"编辑读者":"新增读者","model-value":v.value,onClose:T},{footer:o(()=>[l(L,{onClick:q,class:"form-button"},{default:o(()=>[...r[5]||(r[5]=[c("取消",-1)])]),_:1}),l(L,{type:"primary",onClick:f,class:"form-button",loading:V.value},{default:o(()=>[c(te(V.value?"保存中...":"保存"),1)]),_:1},8,["loading"])]),default:o(()=>[l(z,{model:a,rules:b,ref_key:"formRef",ref:R,"label-width":"110px",class:"reader-form"},{default:o(()=>[l(w,{label:"姓名",prop:"name"},{default:o(()=>[l(_,{modelValue:a.name,"onUpdate:modelValue":r[0]||(r[0]=m=>a.name=m),placeholder:"请输入姓名"},null,8,["modelValue"])]),_:1}),l(w,{label:"证件类型",prop:"idType"},{default:o(()=>[l(U,{modelValue:a.idType,"onUpdate:modelValue":r[1]||(r[1]=m=>a.idType=m),placeholder:"请选择证件类型",style:{width:"100%"}},{default:o(()=>[l(N,{label:"身份证",value:"身份证"}),l(N,{label:"护照",value:"护照"}),l(N,{label:"学生证",value:"学生证"})]),_:1},8,["modelValue"])]),_:1}),l(w,{label:"证件号",prop:"idNumber"},{default:o(()=>[l(_,{modelValue:a.idNumber,"onUpdate:modelValue":r[2]||(r[2]=m=>a.idNumber=m),placeholder:"请输入证件号"},null,8,["modelValue"])]),_:1}),l(w,{label:"电话",prop:"phone"},{default:o(()=>[l(_,{modelValue:a.phone,"onUpdate:modelValue":r[3]||(r[3]=m=>a.phone=m),placeholder:"请输入电话"},null,8,["modelValue"])]),_:1}),l(w,{label:"可借书数",prop:"borrowLimit"},{default:o(()=>[l($,{modelValue:a.borrowLimit,"onUpdate:modelValue":r[4]||(r[4]=m=>a.borrowLimit=m),min:0,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["title","model-value"])}}},fe=Y(ce,[["__scopeId","data-v-53ec2b4e"]]),ve={class:"toolbar"},be={class:"actions"},Se={__name:"ReaderList",setup(I){const D=ae(),p=ne(),d=i({search:""}),R=i([]),V=i(0),v=i(1),k=i(10),a=i(!1),S=i(null),C=i(!1),b=i(null),T=i(!1),q=i([]);async function f(){T.value=!0;try{const e=await ue({page:v.value,size:k.value,search:d.value.search});e&&e.code===0&&(R.value=e.data.items.map(t=>({...t,statusText:t.status===0?"正常":t.status===1?"挂失":"注销"})),V.value=e.data.total)}catch(e){x.error("获取读者列表失败: "+(e.message||e))}finally{T.value=!1}}oe(async()=>{await f();const e=D.query.editId||D.query.editId===0?String(D.query.editId):null;if(e)try{const t=await re(e);t&&t.code===0&&(b.value=t.data,C.value=!0,p.replace({path:"/readers",query:{}}))}catch(t){console.error("打开编辑失败",t)}});function u(){v.value=1,f()}function r(e){v.value=e,f()}function _(e){k.value=e,v.value=1,f()}function w(e){q.value=e}function N(){b.value=null,C.value=!0}function U(e){b.value={...e},C.value=!0}function $(){C.value=!1}function z(e){p.push(`/readers/${e.id}`)}function L(){d.value.search="",v.value=1,k.value=10,f()}async function B(e){var t;try{const n=(t=b.value)!=null&&t.id?await ie(b.value.id,e):await de(e);n&&n.code===0?(x.success("保存成功"),C.value=!1,f()):x.error((n==null?void 0:n.message)||"保存失败")}catch(n){x.error("保存失败: "+(n.message||n))}}function m(e){S.value=e,a.value=!0}function P(){S.value=null,a.value=!1}async function Z(){try{const e=await se(S.value.id);e&&e.code===0?(x.success("删除成功"),a.value=!1,S.value=null,f()):x.error((e==null?void 0:e.message)||"删除失败")}catch(e){x.error("删除失败: "+(e.message||e))}}function G(){const e=["姓名","读者卡号","证件号","电话","注册日期","状态","可借书数"],t=R.value.map(n=>[n.name,n.id,n.idNumber,n.phone,n.registerDate,n.status,n.borrowLimit]);pe(`readers_${Date.now()}.csv`,e,t)}function H(e){return me(e),!1}return(e,t)=>{const n=s("el-input"),X=s("el-form-item"),g=s("el-button"),A=s("el-upload"),y=s("el-table-column"),J=s("el-dialog");return M(),E(K,null,{default:o(()=>[F("div",ve,[l(W,{onSearch:u,onReset:L},{fields:o(()=>[l(X,{label:"搜索"},{default:o(()=>[l(n,{modelValue:d.value.search,"onUpdate:modelValue":t[0]||(t[0]=h=>d.value.search=h),placeholder:"姓名/证件号"},null,8,["modelValue"])]),_:1})]),_:1}),F("div",be,[l(A,{"show-file-list":!1,"before-upload":H},{default:o(()=>[l(g,null,{default:o(()=>[...t[2]||(t[2]=[c("导入 CSV",-1)])]),_:1})]),_:1}),l(g,{onClick:G},{default:o(()=>[...t[3]||(t[3]=[c("导出 CSV",-1)])]),_:1}),l(g,{type:"primary",onClick:N},{default:o(()=>[...t[4]||(t[4]=[c("新增读者",-1)])]),_:1})])]),l(Q,{data:R.value,total:V.value,page:v.value,"page-size":k.value,onPageChange:r,onSizeChange:_,loading:T.value,onSelectionChange:w},{columns:o(()=>[l(y,{prop:"name",label:"姓名"}),l(y,{prop:"id",label:"读者ID"}),l(y,{prop:"idNumber",label:"证件号"}),l(y,{prop:"phone",label:"电话"}),l(y,{prop:"registerDate",label:"注册日期"}),l(y,{prop:"statusText",label:"状态"}),l(y,{prop:"currentBorrowCount",label:"当前借阅数"}),l(y,{label:"操作"},{default:o(({row:h})=>[l(g,{type:"text",onClick:j=>U(h)},{default:o(()=>[...t[5]||(t[5]=[c("编辑",-1)])]),_:1},8,["onClick"]),l(g,{type:"text",onClick:j=>m(h)},{default:o(()=>[...t[6]||(t[6]=[c("删除",-1)])]),_:1},8,["onClick"]),l(g,{type:"text",onClick:j=>z(h)},{default:o(()=>[...t[7]||(t[7]=[c("详情",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data","total","page","page-size","loading"]),l(J,{title:"确认删除",modelValue:a.value,"onUpdate:modelValue":t[1]||(t[1]=h=>a.value=h),width:"30%"},{footer:o(()=>[l(g,{onClick:P},{default:o(()=>[...t[8]||(t[8]=[c("取 消",-1)])]),_:1}),l(g,{type:"primary",onClick:Z},{default:o(()=>[...t[9]||(t[9]=[c("确 定",-1)])]),_:1})]),default:o(()=>[t[10]||(t[10]=F("span",null,"确定要删除这个读者吗？",-1))]),_:1},8,["modelValue"]),l(fe,{visible:C.value,reader:b.value,onSave:B,onCancel:$},null,8,["visible","reader"])]),_:1})}}};export{Se as default};
