import{r as c,q as P,G as A,H as n,ay as p,y as Y,P as o,X as F,L as C}from"./vendor_vue-DcrwGJHO.js";import{L}from"./Layout-BGNV5PTI.js";import{D as O}from"./DataTable-BPSVB8sg.js";import{f as I,r as U}from"./borrow-ByKR0lJe.js";import{a as V,f as T}from"./reader-DiP4nMq6.js";import{b as E}from"./statistics-AZdWBwl5.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{E as u}from"./vendor_element-BfRFdgV9.js";import"./index-xceKWyYj.js";import"./vendor_misc-BnRtHUQB.js";const G={__name:"ReturnPage",setup(H){const i=c(""),b=c("borrowed"),g=c([]),v=c(1),_=c(10),r=c(0),s=c([]),w=c(!1);P(()=>{y()});async function x(){v.value=1,await y()}function z(){i.value="",b.value="borrowed",g.value=[],v.value=1,_.value=10,y()}async function N(l){v.value=l,y()}async function B(l){_.value=l,v.value=1,y()}async function y(){w.value=!0;try{if(b.value==="borrowed"||b.value==="all"){const l={page:v.value,size:_.value,status:"borrowed"};if(g.value&&g.value.length===2&&(l.borrowDateFrom=g.value[0],l.borrowDateTo=g.value[1]),i.value)try{const a=await V(i.value);if(a&&a.code===0&&a.data&&a.data.id)l.readerId=a.data.id;else{const t=await T({search:i.value});if(t&&t.code===0&&t.data&&t.data.items&&t.data.items.length>0)l.readerId=t.data.items[0].id;else{s.value=[],r.value=0,u.warning("未找到匹配的读者，已清空结果"),w.value=!1;return}}}catch(a){u.error("查找读者失败: "+(a.message||a)),w.value=!1;return}const e=await I(l);if(e&&e.code===0){const a=e.data||{},t=a.items||a||[];s.value=S(t),r.value=a.total??(Array.isArray(t)?t.length:0)}else u.error((e==null?void 0:e.message)||"加载借阅记录失败"),s.value=[],r.value=0}else if(b.value==="overdue")if(i.value)try{let l=null;const e=await V(i.value);if(e&&e.code===0&&e.data&&e.data.id)l=e.data.id;else{const t=await T({search:i.value});if(t&&t.code===0&&t.data&&t.data.items&&t.data.items.length>0)l=t.data.items[0].id;else{s.value=[],r.value=0,u.warning("未找到匹配的读者，已清空结果"),w.value=!1;return}}const a=await I({readerId:l,status:"borrowed",page:v.value,size:_.value});if(a&&a.code===0){const d=(a.data.items||a.data||[]||[]).filter(h=>{const k=h.dueDate||h.due_date;if(!k)return!1;const D=new Date(k),R=new Date;return D<new Date(R.toDateString())});s.value=S(d),r.value=d.length}else u.error((a==null?void 0:a.message)||"加载借阅记录失败"),s.value=[],r.value=0}catch(l){u.error("加载逾期记录失败: "+(l.message||l)),s.value=[],r.value=0}else try{const l=(v.value-1)*_.value,e=_.value,a=await E({offset:l,limit:e});if(a&&a.code===0){const t=Array.isArray(a.data)?a.data:a.data&&a.data.items?a.data.items:[];s.value=S(t),r.value=t.length}else u.error((a==null?void 0:a.message)||"加载逾期记录失败"),s.value=[],r.value=0}catch(l){u.error("加载逾期记录失败: "+(l.message||l)),s.value=[],r.value=0}else b.value="borrowed",await y()}catch(l){u.error("加载借阅记录失败: "+(l.message||l)),s.value=[],r.value=0}finally{w.value=!1}}function S(l){return(l||[]).map(e=>{let a="未知",t=0;if(e.borrowStates===0||e.borrowStatus===0||e.status===0){a="在借";const d=e.dueDate||e.due_date;if(d){const h=new Date(d),D=new Date-h;t=Math.ceil(D/(1e3*60*60*24)),t<0&&(t=0)}}else e.borrowStates===1||e.borrowStatus===1?a="已还":(e.borrowStates===2||e.borrowStatus===2)&&(a="逾期",t=e.overdueDays||e.overdue_days||0);return{...e,statusText:a,overdueDays:t,borrowId:e.borrowId??e.id??e.borrow_id,bookTitle:e.bookTitle??e.title??e.bookName??e.book_name,readerName:e.readerName??e.reader_name??(e.reader&&(e.reader.name||e.reader.readerName))}})}async function M(l){l.returning=!0;try{const e=await U({borrowIds:[l.borrowId],returnDate:new Date().toISOString().slice(0,10)});e&&e.code===0?(u.success("归还成功"),y()):u.error((e==null?void 0:e.message)||"归还失败")}catch(e){u.error("归还失败: "+(e.message||e))}finally{l.returning=!1}}return(l,e)=>{const a=p("el-input"),t=p("el-form-item"),d=p("el-option"),h=p("el-select"),k=p("el-date-picker"),D=p("el-button"),R=p("el-form"),f=p("el-table-column");return Y(),A(L,null,{default:n(()=>[o(R,{inline:!0,class:"filter-form",onSubmit:e[3]||(e[3]=F(()=>{},["prevent"]))},{default:n(()=>[o(t,{label:"读者"},{default:n(()=>[o(a,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=m=>i.value=m),placeholder:"读者卡号、姓名或证件号"},null,8,["modelValue"])]),_:1}),o(t,{label:"状态"},{default:n(()=>[o(h,{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=m=>b.value=m),placeholder:"状态",clearable:!1,style:{width:"140px"}},{default:n(()=>[o(d,{label:"全部",value:"all"}),o(d,{label:"在借",value:"borrowed"}),o(d,{label:"逾期",value:"overdue"})]),_:1},8,["modelValue"])]),_:1}),o(t,{label:"借出日期"},{default:n(()=>[o(k,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=m=>g.value=m),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),o(t,null,{default:n(()=>[o(D,{type:"primary",onClick:x,loading:w.value},{default:n(()=>[...e[4]||(e[4]=[C("筛选",-1)])]),_:1},8,["loading"]),o(D,{onClick:z},{default:n(()=>[...e[5]||(e[5]=[C("重置",-1)])]),_:1})]),_:1})]),_:1}),o(O,{data:s.value,loading:w.value,total:r.value,page:v.value,"page-size":_.value,"show-selection":!1,onPageChange:N,onSizeChange:B},{columns:n(()=>[o(f,{prop:"borrowId",label:"借阅编号"}),o(f,{prop:"bookTitle",label:"书名"}),o(f,{prop:"readerName",label:"读者姓名"}),o(f,{prop:"borrowDate",label:"借出日期"}),o(f,{prop:"dueDate",label:"应还日期"}),o(f,{prop:"overdueDays",label:"逾期天数"}),o(f,{prop:"statusText",label:"状态"}),o(f,{label:"操作"},{default:n(({row:m})=>[o(D,{onClick:X=>M(m),loading:m.returning,disabled:m.borrowStates!==0},{default:n(()=>[...e[6]||(e[6]=[C("归还",-1)])]),_:1},8,["onClick","loading","disabled"])]),_:1})]),_:1},8,["data","loading","total","page","page-size"])]),_:1})}}},le=q(G,[["__scopeId","data-v-c21a0cdb"]]);export{le as default};
